---
title: 从 ASP.NET Core 3.1 迁移到5。0
author: scottaddie
description: 了解如何将 ASP.NET Core 3.1 项目迁移到 ASP.NET Core 5.0。
ms.author: scaddie
ms.custom: mvc
ms.date: 12/02/2020
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: migration/31-to-50
ms.openlocfilehash: 1a4dcdee738eb05f62c3268d9ef579974dd99cf4
ms.sourcegitcommit: b64c44ba5e3abb4ad4d50de93b7e282bf0f251e4
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/07/2021
ms.locfileid: "97972088"
---
# <a name="migrate-from-aspnet-core-31-to-50"></a><span data-ttu-id="f239b-103">从 ASP.NET Core 3.1 迁移到5。0</span><span class="sxs-lookup"><span data-stu-id="f239b-103">Migrate from ASP.NET Core 3.1 to 5.0</span></span>

<span data-ttu-id="f239b-104">作者：[Scott Addie](https://github.com/scottaddie)</span><span class="sxs-lookup"><span data-stu-id="f239b-104">By [Scott Addie](https://github.com/scottaddie)</span></span>

<span data-ttu-id="f239b-105">本文介绍如何将现有 ASP.NET Core 3.1 项目更新为 ASP.NET Core 5.0。</span><span class="sxs-lookup"><span data-stu-id="f239b-105">This article explains how to update an existing ASP.NET Core 3.1 project to ASP.NET Core 5.0.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="f239b-106">先决条件</span><span class="sxs-lookup"><span data-stu-id="f239b-106">Prerequisites</span></span>

# <a name="visual-studio"></a>[<span data-ttu-id="f239b-107">Visual Studio</span><span class="sxs-lookup"><span data-stu-id="f239b-107">Visual Studio</span></span>](#tab/visual-studio)

[!INCLUDE[](~/includes/net-core-prereqs-vs-5.0.md)]

# <a name="visual-studio-code"></a>[<span data-ttu-id="f239b-108">Visual Studio Code</span><span class="sxs-lookup"><span data-stu-id="f239b-108">Visual Studio Code</span></span>](#tab/visual-studio-code)

[!INCLUDE[](~/includes/net-core-prereqs-vsc-5.0.md)]

# <a name="visual-studio-for-mac"></a>[<span data-ttu-id="f239b-109">Visual Studio for Mac</span><span class="sxs-lookup"><span data-stu-id="f239b-109">Visual Studio for Mac</span></span>](#tab/visual-studio-mac)

[!INCLUDE[](~/includes/net-core-prereqs-mac-5.0.md)]

---

## <a name="update-net-core-sdk-version-in-globaljson"></a><span data-ttu-id="f239b-110">在 global.json 中更新 .NET Core SDK 版本</span><span class="sxs-lookup"><span data-stu-id="f239b-110">Update .NET Core SDK version in global.json</span></span>

<span data-ttu-id="f239b-111">如果依赖于文件的 [global.js](/dotnet/core/tools/global-json) 针对特定 .NET Core SDK 版本，请将 `version` 属性更新为安装的 .net 5.0 SDK 版本。</span><span class="sxs-lookup"><span data-stu-id="f239b-111">If you rely upon a [global.json](/dotnet/core/tools/global-json) file to target a specific .NET Core SDK version, update the `version` property to the .NET 5.0 SDK version that's installed.</span></span> <span data-ttu-id="f239b-112">例如：</span><span class="sxs-lookup"><span data-stu-id="f239b-112">For example:</span></span>

```diff
{
  "sdk": {
-    "version": "3.1.200"
+    "version": "5.0.100"
  }
}
```

## <a name="update-the-target-framework"></a><span data-ttu-id="f239b-113">更新目标框架</span><span class="sxs-lookup"><span data-stu-id="f239b-113">Update the target framework</span></span>

<span data-ttu-id="f239b-114">如果更新 Blazor WebAssembly 项目，请跳到 " [更新 Blazor WebAssembly 项目](#update-blazor-webassembly-projects) " 部分。</span><span class="sxs-lookup"><span data-stu-id="f239b-114">If updating a Blazor WebAssembly project, skip to the [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) section.</span></span> <span data-ttu-id="f239b-115">对于任何其他 ASP.NET Core 项目类型，将项目文件的 [目标框架名字对象 (TFM) ](/dotnet/standard/frameworks) 更新为 `net5.0` ：</span><span class="sxs-lookup"><span data-stu-id="f239b-115">For any other ASP.NET Core project type, update the project file's [Target Framework Moniker (TFM)](/dotnet/standard/frameworks) to `net5.0`:</span></span>

```diff
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
-    <TargetFramework>netcoreapp3.1</TargetFramework>
+    <TargetFramework>net5.0</TargetFramework>
  </PropertyGroup>

</Project>
```

## <a name="changes-to-no-locblazor-app-routing-logic-in-501"></a><span data-ttu-id="f239b-116">Blazor5.0.1 中对应用路由逻辑的更改</span><span class="sxs-lookup"><span data-stu-id="f239b-116">Changes to Blazor app routing logic in 5.0.1</span></span>

<span data-ttu-id="f239b-117">在 ASP.NET Core 5.0.1 修补程序版本中，路由优先顺序发生了变化。</span><span class="sxs-lookup"><span data-stu-id="f239b-117">The computation of route precedence changed in the ASP.NET Core 5.0.1 patch release.</span></span> <span data-ttu-id="f239b-118">如果您定义了 "全部捕获路由" 或带可选参数的路由，则这可能会影响您。</span><span class="sxs-lookup"><span data-stu-id="f239b-118">This might affect you if you've defined catch-all routes or routes with optional parameters.</span></span>

### <a name="old-behavior"></a><span data-ttu-id="f239b-119">旧行为</span><span class="sxs-lookup"><span data-stu-id="f239b-119">Old behavior</span></span>

<span data-ttu-id="f239b-120">随着前面 ASP.NET Core 5.0.0 或更早版本的行为，具有较低优先级的路由（如 `{*slug}` ）将在优先级较高的路由之前进行匹配，例如 `/customer/{id}` 。</span><span class="sxs-lookup"><span data-stu-id="f239b-120">With the prior behavior in ASP.NET Core 5.0.0 or earlier, routes with lower precedence, such as `{*slug}`, are matched before routes with higher precedence, such as `/customer/{id}`.</span></span>

### <a name="new-behavior"></a><span data-ttu-id="f239b-121">新行为</span><span class="sxs-lookup"><span data-stu-id="f239b-121">New behavior</span></span>

<span data-ttu-id="f239b-122">ASP.NET Core 5.0.1 或更高版本中的新行为与 ASP.NET Core 应用中定义的路由行为更匹配，其中，框架将首先计算并建立每个段的路由优先级，并且只使用路由的长度将相关作为次要条件进行中断。</span><span class="sxs-lookup"><span data-stu-id="f239b-122">The new behavior in ASP.NET Core 5.0.1 or later more closely matches the routing behavior defined in ASP.NET Core apps, where the framework computes and establishes the route precedence for each segment first and only uses the length of the route to break ties as a secondary criteria.</span></span>

### <a name="reason-for-change"></a><span data-ttu-id="f239b-123">更改原因</span><span class="sxs-lookup"><span data-stu-id="f239b-123">Reason for change</span></span>

<span data-ttu-id="f239b-124">原始行为被视为实现中的 bug，因为我们的目标是使 Blazor 路由系统的行为与 ASP.NET Core 路由系统的行为方式与路由支持的功能子集的行为相同 Blazor 。</span><span class="sxs-lookup"><span data-stu-id="f239b-124">The original behavior is considered a bug in the implementation because our goal is for the Blazor routing system to behave in the same way as the ASP.NET Core routing system for the subset of features supported by Blazor routing.</span></span>

### <a name="recommended-action"></a><span data-ttu-id="f239b-125">建议的操作</span><span class="sxs-lookup"><span data-stu-id="f239b-125">Recommended action</span></span>

<span data-ttu-id="f239b-126">将 `PreferExactMatches` 属性添加到 `Router` 文件中的组件 `App.razor` ，以选择正确的行为：</span><span class="sxs-lookup"><span data-stu-id="f239b-126">Add the `PreferExactMatches` attribute to the `Router` component in the `App.razor` file to opt into the correct behavior:</span></span>

```razor
<Router AppAssembly="@typeof(Program).Assembly" PreferExactMatches="@true">
```

<span data-ttu-id="f239b-127">当 `PreferExactMatches` 设置为时 `@true` ，路由匹配优先于通配符的完全匹配。</span><span class="sxs-lookup"><span data-stu-id="f239b-127">When `PreferExactMatches` is set to `@true`, route matching prefers exact matches over wildcards.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="f239b-128">所有应用都应显式设置 `PreferExactMatches` 为 `@true` 。</span><span class="sxs-lookup"><span data-stu-id="f239b-128">All apps should explicitly set `PreferExactMatches` to `@true`.</span></span>
>
> <span data-ttu-id="f239b-129">设置 `PreferExactMatches` 为 `@false` 或将其设置为未设置的功能（默认情况下， `false` c # 中的选项） *仅用于向后兼容*。</span><span class="sxs-lookup"><span data-stu-id="f239b-129">The ability to set `PreferExactMatches` to `@false` or leave it unset, which defaults the option to `false` in C#, *is only provided for backward compatibility*.</span></span>
>
> <span data-ttu-id="f239b-130">当发布 .NET 6 时，路由器将始终首选完全匹配项，并且该 `PreferExactMatches` 选项将不可用。</span><span class="sxs-lookup"><span data-stu-id="f239b-130">When .NET 6 is released, the router will always prefer exact matches, and the `PreferExactMatches` option won't be available.</span></span>

## <a name="update-no-locblazor-webassembly-and-no-locblazor-server-projects"></a><span data-ttu-id="f239b-131">更新 Blazor WebAssembly 和 Blazor Server 项目</span><span class="sxs-lookup"><span data-stu-id="f239b-131">Update Blazor WebAssembly and Blazor Server projects</span></span>

<span data-ttu-id="f239b-132">*本部分中的指南适用于这两种 Blazor 托管模型。本部分后面的部分提供特定于托管模型和应用类型的其他指导。将所有相关部分的指南应用于应用。*</span><span class="sxs-lookup"><span data-stu-id="f239b-132">*The guidance in this section applies to both Blazor hosting models. Sections following this section provide additional guidance specific to hosting models and app types. Apply the guidance from all relevant sections to your app.*</span></span>

1. <span data-ttu-id="f239b-133">在 `wwwroot/index.html` Blazor WebAssembly 应用或应用的中 `Pages/_Host.cshtml` Blazor Server ，将 `<link>` 元素添加到样式的元素中 `<head>` 。</span><span class="sxs-lookup"><span data-stu-id="f239b-133">In `wwwroot/index.html` of a Blazor WebAssembly app or the `Pages/_Host.cshtml` of a Blazor Server app, add a `<link>` element to the `<head>` element for styles.</span></span> <span data-ttu-id="f239b-134">在以下 `<link>` 元素 `href` 属性值中，占位符 `{ASSEMBLY NAME}` 是应用的程序集名称。</span><span class="sxs-lookup"><span data-stu-id="f239b-134">In the following `<link>` element `href` attribute values, the placeholder `{ASSEMBLY NAME}` is the app's assembly name.</span></span>

    ```diff
    +<link href="{ASSEMBLY NAME}.styles.css" rel="stylesheet" />
    ```
    
    <span data-ttu-id="f239b-135">独立 Blazor WebAssembly 或 Blazor Server 示例：</span><span class="sxs-lookup"><span data-stu-id="f239b-135">Standalone Blazor WebAssembly or Blazor Server example:</span></span>
    
    ```diff
    +<link href="BlazorSample.styles.css" rel="stylesheet" />
    ```

    <span data-ttu-id="f239b-136">*`Client`* 托管 Blazor WebAssembly 解决方案示例的项目：</span><span class="sxs-lookup"><span data-stu-id="f239b-136">*`Client`* project of a hosted Blazor WebAssembly solution example:</span></span>
    
    ```diff
    +<link href="BlazorSample.Client.styles.css" rel="stylesheet" />
    ```

1. <span data-ttu-id="f239b-137">在应用的文件中包括新的命名空间 `_Imports.razor` ，以供 [组件虚拟化](xref:blazor/components/virtualization)使用 <xref:Microsoft.AspNetCore.Components.Web.Virtualization?displayProperty=fullName> 。</span><span class="sxs-lookup"><span data-stu-id="f239b-137">Include a new namespace in the app's `_Imports.razor` file for [component virtualization](xref:blazor/components/virtualization), <xref:Microsoft.AspNetCore.Components.Web.Virtualization?displayProperty=fullName>.</span></span> <span data-ttu-id="f239b-138">以下 `_Imports.razor` 文件显示了从项目模板生成的应用中的默认命名空间 Blazor 。</span><span class="sxs-lookup"><span data-stu-id="f239b-138">The following `_Imports.razor` files show the default namespaces in apps generated from the Blazor project templates.</span></span> <span data-ttu-id="f239b-139">占位符 `{ASSEMBLY NAME}` 是应用程序的程序集名称。</span><span class="sxs-lookup"><span data-stu-id="f239b-139">The placeholder `{ASSEMBLY NAME}` is the app's assembly name.</span></span>

   <span data-ttu-id="f239b-140">Blazor WebAssembly (`_Imports.razor`):</span><span class="sxs-lookup"><span data-stu-id="f239b-140">Blazor WebAssembly (`_Imports.razor`):</span></span>
   
   ```razor
   @using System.Net.Http
   @using System.Net.Http.Json
   @using Microsoft.AspNetCore.Components.Forms
   @using Microsoft.AspNetCore.Components.Routing
   @using Microsoft.AspNetCore.Components.Web
   @using Microsoft.AspNetCore.Components.Web.Virtualization
   @using Microsoft.AspNetCore.Components.WebAssembly.Http
   @using Microsoft.JSInterop
   @using {ASSEMBLY NAME}
   @using {ASSEMBLY NAME}.Shared
   ```

   <span data-ttu-id="f239b-141">Blazor Server (`_Imports.razor`):</span><span class="sxs-lookup"><span data-stu-id="f239b-141">Blazor Server (`_Imports.razor`):</span></span>
   
   ```razor
   @using System.Net.Http
   @using Microsoft.AspNetCore.Authorization
   @using Microsoft.AspNetCore.Components.Authorization
   @using Microsoft.AspNetCore.Components.Forms
   @using Microsoft.AspNetCore.Components.Routing
   @using Microsoft.AspNetCore.Components.Web
   @using Microsoft.AspNetCore.Components.Web.Virtualization
   @using Microsoft.JSInterop
   @using {ASSEMBLY NAME}
   @using {ASSEMBLY NAME}.Shared
   ```
   
1. <span data-ttu-id="f239b-142">在 `MainLayout` 组件 (`Shared/MainLayout.razor`) 中，将组件的 HTML 标记括在 `<div>` `class` 属性设置为的元素中 `page` ：</span><span class="sxs-lookup"><span data-stu-id="f239b-142">In the `MainLayout` component (`Shared/MainLayout.razor`), surround the component's HTML markup with a `<div>` element that has a `class` attribute set to `page`:</span></span>

    ```razor
    <div class="page">
    
        ...
        
    </div>
    ```
    
1. <span data-ttu-id="f239b-143">将以下文件添加到该 `Shared` 文件夹：</span><span class="sxs-lookup"><span data-stu-id="f239b-143">Add the following files to the `Shared` folder:</span></span>

    <span data-ttu-id="f239b-144">`MainLayout.razor.css`:</span><span class="sxs-lookup"><span data-stu-id="f239b-144">`MainLayout.razor.css`:</span></span>
    
    ```css
    .page {
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .main {
        flex: 1;
    }

    .sidebar {
        background-image: linear-gradient(180deg, rgb(5, 39, 103) 0%, #3a0647 70%);
    }

    .top-row {
        background-color: #f7f7f7;
        border-bottom: 1px solid #d6d5d5;
        justify-content: flex-end;
        height: 3.5rem;
        display: flex;
        align-items: center;
    }

        .top-row ::deep a, .top-row .btn-link {
            white-space: nowrap;
            margin-left: 1.5rem;
        }

        .top-row a:first-child {
            overflow: hidden;
            text-overflow: ellipsis;
        }

    @media (max-width: 767.98px) {
        .top-row:not(.auth) {
            display: none;
        }

        .top-row.auth {
            justify-content: space-between;
        }

        .top-row a, .top-row .btn-link {
            margin-left: 0;
        }
    }

    @media (min-width: 768px) {
        .page {
            flex-direction: row;
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .top-row {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .main > div {
            padding-left: 2rem !important;
            padding-right: 1.5rem !important;
        }
    }
    ```
    
    <span data-ttu-id="f239b-145">`NavMenu.razor.css`:</span><span class="sxs-lookup"><span data-stu-id="f239b-145">`NavMenu.razor.css`:</span></span>
    
    ```css
    .navbar-toggler {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .top-row {
        height: 3.5rem;
        background-color: rgba(0,0,0,0.4);
    }

    .navbar-brand {
        font-size: 1.1rem;
    }

    .oi {
        width: 2rem;
        font-size: 1.1rem;
        vertical-align: text-top;
        top: -2px;
    }

    .nav-item {
        font-size: 0.9rem;
        padding-bottom: 0.5rem;
    }

        .nav-item:first-of-type {
            padding-top: 1rem;
        }

        .nav-item:last-of-type {
            padding-bottom: 1rem;
        }

        .nav-item ::deep a {
            color: #d7d7d7;
            border-radius: 4px;
            height: 3rem;
            display: flex;
            align-items: center;
            line-height: 3rem;
        }

    .nav-item ::deep a.active {
        background-color: rgba(255,255,255,0.25);
        color: white;
    }

    .nav-item ::deep a:hover {
        background-color: rgba(255,255,255,0.1);
        color: white;
    }

    @media (min-width: 768px) {
        .navbar-toggler {
            display: none;
        }

        .collapse {
            /* Never collapse the sidebar for wide screens */
            display: block;
        }
    }
    ```

1. <span data-ttu-id="f239b-146">应用程序或应用程序文件的最新基本 `wwwroot/css/app.css` 文件 Blazor WebAssembly `wwwroot/css/site.css` Blazor Server 包含以下样式。</span><span class="sxs-lookup"><span data-stu-id="f239b-146">The latest base `wwwroot/css/app.css` file of a Blazor WebAssembly app or `wwwroot/css/site.css` file of a Blazor Server app includes the following styles.</span></span> <span data-ttu-id="f239b-147">删除附加样式，使其保留以下样式和任何已添加到应用的样式。</span><span class="sxs-lookup"><span data-stu-id="f239b-147">Remove extra styles leaving the following styles and any that you've added to the app.</span></span>

    <span data-ttu-id="f239b-148">以下样式表仅包含基本样式，不 **包括开发** 人员添加的自定义样式：</span><span class="sxs-lookup"><span data-stu-id="f239b-148">The following stylesheet only includes base styles and does **not** include custom styles added by the developer:</span></span>
   
    ```css
    @import url('open-iconic/font/css/open-iconic-bootstrap.min.css');

    html, body {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    a, .btn-link {
        color: #0366d6;
    }

    .btn-primary {
        color: #fff;
        background-color: #1b6ec2;
        border-color: #1861ac;
    }

    .content {
        padding-top: 1.1rem;
    }

    .valid.modified:not([type=checkbox]) {
        outline: 1px solid #26b050;
    }

    .invalid {
        outline: 1px solid red;
    }

    .validation-message {
        color: red;
    }

    #blazor-error-ui {
        background: lightyellow;
        bottom: 0;
        box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.2);
        display: none;
        left: 0;
        padding: 0.6rem 1.25rem 0.7rem 1.25rem;
        position: fixed;
        width: 100%;
        z-index: 1000;
    }

    #blazor-error-ui .dismiss {
        cursor: pointer;
        position: absolute;
        right: 0.75rem;
        top: 0.5rem;
    }
    ```

## <a name="update-no-locblazor-webassembly-projects"></a><span data-ttu-id="f239b-149">更新 Blazor WebAssembly 项目</span><span class="sxs-lookup"><span data-stu-id="f239b-149">Update Blazor WebAssembly projects</span></span>

<span data-ttu-id="f239b-150">按照前面的 " [更新 Blazor WebAssembly 和 Blazor Server 项目](#update-blazor-webassembly-and-blazor-server-projects) " 部分中的指导进行操作。</span><span class="sxs-lookup"><span data-stu-id="f239b-150">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) section.</span></span>

<span data-ttu-id="f239b-151">对于 Blazor WebAssembly 项目（包括 *`Client`* 托管解决方案的项目） Blazor ，对项目文件应用以下更改：</span><span class="sxs-lookup"><span data-stu-id="f239b-151">For a Blazor WebAssembly project, including the *`Client`* project of a hosted Blazor solution, apply the following changes to the project file:</span></span>

1. <span data-ttu-id="f239b-152">将 SDK 从更新 `Microsoft.NET.Sdk.Web` 为 `Microsoft.NET.Sdk.BlazorWebAssembly` ：</span><span class="sxs-lookup"><span data-stu-id="f239b-152">Update the SDK from `Microsoft.NET.Sdk.Web` to `Microsoft.NET.Sdk.BlazorWebAssembly`:</span></span>

    ```diff
    - <Project Sdk="Microsoft.NET.Sdk.Web">
    + <Project Sdk="Microsoft.NET.Sdk.BlazorWebAssembly">
    ```
    
    > [!NOTE]
    > <span data-ttu-id="f239b-153">此更新仅适用于独立 Blazor WebAssembly 项目和 *`Client`* 托管解决方案的项目 Blazor 。</span><span class="sxs-lookup"><span data-stu-id="f239b-153">This update only applies to standalone Blazor WebAssembly projects and the *`Client`* projects of hosted Blazor solutions.</span></span>

1. <span data-ttu-id="f239b-154">更新以下属性：</span><span class="sxs-lookup"><span data-stu-id="f239b-154">Update the following properties:</span></span>

    ```diff
    <Project Sdk="Microsoft.NET.Sdk.BlazorWebAssembly">
    
      <PropertyGroup>
    -     <TargetFramework>netstandard2.1</TargetFramework>
    -     <RazorLangVersion>3.0</RazorLangVersion>
    +     <TargetFramework>net5.0</TargetFramework>
      </PropertyGroup>
    ```

1. <span data-ttu-id="f239b-155">删除对 AspNetCore 的包引用 [。 WebAssembly](https://www.nuget.org/packages/Microsoft.AspNetCore.Components.WebAssembly.Build)：</span><span class="sxs-lookup"><span data-stu-id="f239b-155">Remove the package reference to [Microsoft.AspNetCore.Components.WebAssembly.Build](https://www.nuget.org/packages/Microsoft.AspNetCore.Components.WebAssembly.Build):</span></span>

    ```diff
    <ItemGroup>
    -    <PackageReference Include="Microsoft.AspNetCore.Components.WebAssembly.Build" Version="3.2.1" PrivateAssets="all" />
    ```

1. <span data-ttu-id="f239b-156">将其他包更新到其最新版本。</span><span class="sxs-lookup"><span data-stu-id="f239b-156">Update other packages to their latest versions.</span></span> <span data-ttu-id="f239b-157">最新版本可在 [NuGet.org](https://www.nuget.org)上找到。</span><span class="sxs-lookup"><span data-stu-id="f239b-157">The latest versions can be found at [NuGet.org](https://www.nuget.org).</span></span>

1. <span data-ttu-id="f239b-158">在中 `wwwroot/index.html` ，将加载组件的元素更改 `App` 为一个 `<div>` 元素，并 `id` 将其设置为 `app` ：</span><span class="sxs-lookup"><span data-stu-id="f239b-158">In `wwwroot/index.html`, change the element that loads the `App` component to a `<div>` element with an `id` set to `app`:</span></span>
    
    ```diff
    -<app>Loading...</app>
    +<div id="app">Loading...</div>
    ```
    
1. <span data-ttu-id="f239b-159">在 `Program.Main` (`Program.cs`) 中：</span><span class="sxs-lookup"><span data-stu-id="f239b-159">In `Program.Main` (`Program.cs`):</span></span>

   * <span data-ttu-id="f239b-160">将对元素的引用更改为 `<app>` CSS 选择器，方法是向它添加哈希 `#` 。</span><span class="sxs-lookup"><span data-stu-id="f239b-160">Change the reference to the `<app>` element to a CSS selector by adding a hash `#` to it.</span></span>
   * <span data-ttu-id="f239b-161">将 `HttpClient` 注册更改为范围。</span><span class="sxs-lookup"><span data-stu-id="f239b-161">Change the `HttpClient` registration to scoped.</span></span>

    ```diff
    -builder.RootComponents.Add<App>("app");
    +builder.RootComponents.Add<App>("#app");
    
    -builder.Services.AddTransient(sp => new HttpClient 
    -    { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });
    +builder.Services.AddScoped(sp => new HttpClient 
    +    { BaseAddress = new Uri(builder.HostEnvironment.BaseAddress) });
    ```

### <a name="standalone-no-locblazor-webassembly-app-with-microsoft-accounts"></a><span data-ttu-id="f239b-162">Blazor WebAssemblyMicrosoft 帐户的独立应用</span><span class="sxs-lookup"><span data-stu-id="f239b-162">Standalone Blazor WebAssembly app with Microsoft Accounts</span></span>

<span data-ttu-id="f239b-163">按照前面的 " [更新 Blazor WebAssembly 和 Blazor Server 项目](#update-blazor-webassembly-and-blazor-server-projects) " 和 " [更新 Blazor WebAssembly 项目](#update-blazor-webassembly-projects) " 部分中的指导进行操作。</span><span class="sxs-lookup"><span data-stu-id="f239b-163">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) and [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) sections.</span></span>

<span data-ttu-id="f239b-164">对于在 Blazor WebAssembly Azure 门户中注册的独立应用，若要使用 Microsoft 帐户的 Azure Active Directory (AAD) ：</span><span class="sxs-lookup"><span data-stu-id="f239b-164">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD) for Microsoft Accounts:</span></span>

* <span data-ttu-id="f239b-165">应用需要 `openid` 和 `offline_access` 范围：</span><span class="sxs-lookup"><span data-stu-id="f239b-165">The app requires the `openid` and `offline_access` scopes:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes.Add("openid");
  options.ProviderOptions.DefaultAccessTokenScopes.Add("offline_access");
  ```
  
* <span data-ttu-id="f239b-166">在 "Azure 门户应用注册 **身份验证** " 边栏选项卡中：</span><span class="sxs-lookup"><span data-stu-id="f239b-166">In the Azure portal app registration **Authentication** blade:</span></span>

  1. <span data-ttu-id="f239b-167">删除 **Web** 平台配置。</span><span class="sxs-lookup"><span data-stu-id="f239b-167">Remove the **Web** platform configuration.</span></span>
  1. <span data-ttu-id="f239b-168">使用应用的重定向 URI 添加 **单页应用程序** 平台配置。</span><span class="sxs-lookup"><span data-stu-id="f239b-168">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
  1. <span data-ttu-id="f239b-169">禁用 **访问令牌** 和 **ID 令牌** 的 **隐式授权**。</span><span class="sxs-lookup"><span data-stu-id="f239b-169">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="f239b-170">有关详细信息，请参阅 <xref:blazor/security/webassembly/standalone-with-microsoft-accounts>。</span><span class="sxs-lookup"><span data-stu-id="f239b-170">For more information, see <xref:blazor/security/webassembly/standalone-with-microsoft-accounts>.</span></span>

### <a name="standalone-no-locblazor-webassembly-app-with-azure-active-directory-aad"></a><span data-ttu-id="f239b-171">Blazor WebAssembly具有 Azure Active Directory (AAD) 的独立应用</span><span class="sxs-lookup"><span data-stu-id="f239b-171">Standalone Blazor WebAssembly app with Azure Active Directory (AAD)</span></span>

<span data-ttu-id="f239b-172">按照前面的 " [更新 Blazor WebAssembly 和 Blazor Server 项目](#update-blazor-webassembly-and-blazor-server-projects) " 和 " [更新 Blazor WebAssembly 项目](#update-blazor-webassembly-projects) " 部分中的指导进行操作。</span><span class="sxs-lookup"><span data-stu-id="f239b-172">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) and [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) sections.</span></span>

<span data-ttu-id="f239b-173">对于在 Blazor WebAssembly Azure 门户中注册的独立应用程序以使用 Azure Active Directory (AAD) ：</span><span class="sxs-lookup"><span data-stu-id="f239b-173">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD):</span></span>

* <span data-ttu-id="f239b-174">应用需要 `https://graph.microsoft.com/User.Read` 范围：</span><span class="sxs-lookup"><span data-stu-id="f239b-174">The app requires the `https://graph.microsoft.com/User.Read` scope:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes
      .Add("https://graph.microsoft.com/User.Read");
  ```
  
* <span data-ttu-id="f239b-175">在 "Azure 门户应用注册 **身份验证** " 边栏选项卡中：</span><span class="sxs-lookup"><span data-stu-id="f239b-175">In the Azure portal app registration **Authentication** blade:</span></span>

  1. <span data-ttu-id="f239b-176">删除 **Web** 平台配置。</span><span class="sxs-lookup"><span data-stu-id="f239b-176">Remove the **Web** platform configuration.</span></span>
  1. <span data-ttu-id="f239b-177">使用应用的重定向 URI 添加 **单页应用程序** 平台配置。</span><span class="sxs-lookup"><span data-stu-id="f239b-177">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
  1. <span data-ttu-id="f239b-178">禁用 **访问令牌** 和 **ID 令牌** 的 **隐式授权**。</span><span class="sxs-lookup"><span data-stu-id="f239b-178">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>
  
<span data-ttu-id="f239b-179">有关详细信息，请参阅 <xref:blazor/security/webassembly/standalone-with-azure-active-directory>。</span><span class="sxs-lookup"><span data-stu-id="f239b-179">For more information, see <xref:blazor/security/webassembly/standalone-with-azure-active-directory>.</span></span>

### <a name="standalone-no-locblazor-webassembly-app-with-azure-active-directory-aad-b2c"></a><span data-ttu-id="f239b-180">Blazor WebAssembly (AAD) B2C 的独立应用 Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="f239b-180">Standalone Blazor WebAssembly app with Azure Active Directory (AAD) B2C</span></span>

<span data-ttu-id="f239b-181">按照前面的 " [更新 Blazor WebAssembly 和 Blazor Server 项目](#update-blazor-webassembly-and-blazor-server-projects) " 和 " [更新 Blazor WebAssembly 项目](#update-blazor-webassembly-projects) " 部分中的指导进行操作。</span><span class="sxs-lookup"><span data-stu-id="f239b-181">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) and [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) sections.</span></span>

<span data-ttu-id="f239b-182">对于在 Blazor WebAssembly Azure 门户中注册的独立应用，若要使用 Azure Active Directory (AAD) B2C：</span><span class="sxs-lookup"><span data-stu-id="f239b-182">For a standalone Blazor WebAssembly app registered in the Azure portal to use Azure Active Directory (AAD) B2C:</span></span>

* <span data-ttu-id="f239b-183">应用需要 `openid` 和 `offline_access` 范围：</span><span class="sxs-lookup"><span data-stu-id="f239b-183">The app requires the `openid` and `offline_access` scopes:</span></span>

  ```csharp
  options.ProviderOptions.DefaultAccessTokenScopes.Add("openid");
  options.ProviderOptions.DefaultAccessTokenScopes.Add("offline_access");
  ```
  
* <span data-ttu-id="f239b-184">在 "Azure 门户应用注册 **身份验证** " 边栏选项卡中：</span><span class="sxs-lookup"><span data-stu-id="f239b-184">In the Azure portal app registration **Authentication** blade:</span></span>

  1. <span data-ttu-id="f239b-185">删除 **Web** 平台配置。</span><span class="sxs-lookup"><span data-stu-id="f239b-185">Remove the **Web** platform configuration.</span></span>
  1. <span data-ttu-id="f239b-186">使用应用的重定向 URI 添加 **单页应用程序** 平台配置。</span><span class="sxs-lookup"><span data-stu-id="f239b-186">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
  1. <span data-ttu-id="f239b-187">禁用 **访问令牌** 和 **ID 令牌** 的 **隐式授权**。</span><span class="sxs-lookup"><span data-stu-id="f239b-187">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="f239b-188">有关详细信息，请参阅 <xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c>。</span><span class="sxs-lookup"><span data-stu-id="f239b-188">For more information, see <xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c>.</span></span>

### <a name="hosted-no-locblazor-webassembly-app-with-azure-active-directory-aad-or-aad-b2c"></a><span data-ttu-id="f239b-189">Blazor WebAssembly具有 Azure Active Directory (AAD) 或 AAD B2C 的托管应用</span><span class="sxs-lookup"><span data-stu-id="f239b-189">Hosted Blazor WebAssembly app with Azure Active Directory (AAD) or AAD B2C</span></span>

<span data-ttu-id="f239b-190">按照前面的 " [更新 Blazor WebAssembly 和 Blazor Server 项目](#update-blazor-webassembly-and-blazor-server-projects) " 和 " [更新 Blazor WebAssembly 项目](#update-blazor-webassembly-projects) " 部分中的指导进行操作。</span><span class="sxs-lookup"><span data-stu-id="f239b-190">Follow the guidance in the preceding [Update Blazor WebAssembly and Blazor Server projects](#update-blazor-webassembly-and-blazor-server-projects) and [Update Blazor WebAssembly projects](#update-blazor-webassembly-projects) sections.</span></span>

<span data-ttu-id="f239b-191">*`Client`* Blazor 使用 AAD 或 AAD B2C 进行用户身份验证的托管解决方案的应用注册应使用 **单页面应用程序** Azure 应用平台配置。</span><span class="sxs-lookup"><span data-stu-id="f239b-191">The *`Client`* app registration of a hosted Blazor solution that uses AAD or AAD B2C for user authentication should use a **Single-page application** Azure Apps platform configuration.</span></span>

<span data-ttu-id="f239b-192">在 "Azure 门户 *`Client`* 应用注册 **身份验证** " 边栏选项卡中：</span><span class="sxs-lookup"><span data-stu-id="f239b-192">In the Azure portal *`Client`* app registration **Authentication** blade:</span></span>

  1. <span data-ttu-id="f239b-193">删除 **Web** 平台配置。</span><span class="sxs-lookup"><span data-stu-id="f239b-193">Remove the **Web** platform configuration.</span></span>
  1. <span data-ttu-id="f239b-194">使用应用的重定向 URI 添加 **单页应用程序** 平台配置。</span><span class="sxs-lookup"><span data-stu-id="f239b-194">Add a **Single-page application** platform configuration with the app's redirect URI.</span></span>
  1. <span data-ttu-id="f239b-195">禁用 **访问令牌** 和 **ID 令牌** 的 **隐式授权**。</span><span class="sxs-lookup"><span data-stu-id="f239b-195">Disable **Implicit grant** for **Access tokens** and **ID tokens**.</span></span>

<span data-ttu-id="f239b-196">有关详细信息，请参阅：</span><span class="sxs-lookup"><span data-stu-id="f239b-196">For more information, see:</span></span>

* <xref:blazor/security/webassembly/hosted-with-azure-active-directory>
* <xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c>

### <a name="update-the-server-project-of-a-hosted-no-locblazor-solution"></a><span data-ttu-id="f239b-197">更新托管解决方案的服务器项目 Blazor</span><span class="sxs-lookup"><span data-stu-id="f239b-197">Update the Server project of a hosted Blazor solution</span></span>

<span data-ttu-id="f239b-198">按照前面几节中的指导进行操作：</span><span class="sxs-lookup"><span data-stu-id="f239b-198">Follow the guidance in the preceding sections:</span></span>

* [<span data-ttu-id="f239b-199">更新 Blazor WebAssembly 和 Blazor Server 项目</span><span class="sxs-lookup"><span data-stu-id="f239b-199">Update Blazor WebAssembly and Blazor Server projects</span></span>](#update-blazor-webassembly-and-blazor-server-projects)
* [<span data-ttu-id="f239b-200">更新 Blazor WebAssembly 项目</span><span class="sxs-lookup"><span data-stu-id="f239b-200">Update Blazor WebAssembly projects</span></span>](#update-blazor-webassembly-projects)
* <span data-ttu-id="f239b-201">适用于应用程序提供程序 Azure Active Directory 的部分：</span><span class="sxs-lookup"><span data-stu-id="f239b-201">The section that applies to the app's provider with Azure Active Directory:</span></span>
  * [<span data-ttu-id="f239b-202">Blazor WebAssemblyMicrosoft 帐户的独立应用</span><span class="sxs-lookup"><span data-stu-id="f239b-202">Standalone Blazor WebAssembly app with Microsoft Accounts</span></span>](#standalone-blazor-webassembly-app-with-microsoft-accounts)
  * [<span data-ttu-id="f239b-203">Blazor WebAssembly具有 Azure Active Directory (AAD) 的独立应用</span><span class="sxs-lookup"><span data-stu-id="f239b-203">Standalone Blazor WebAssembly app with Azure Active Directory (AAD)</span></span>](#standalone-blazor-webassembly-app-with-azure-active-directory-aad)
  * [<span data-ttu-id="f239b-204">Blazor WebAssembly (AAD) B2C 的独立应用 Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="f239b-204">Standalone Blazor WebAssembly app with Azure Active Directory (AAD) B2C</span></span>](#standalone-blazor-webassembly-app-with-azure-active-directory-aad-b2c)

<span data-ttu-id="f239b-205">*`Server`* Blazor 按照本文中的一般指导，将托管解决方案的项目更新为 ASP.NET Core 应用。</span><span class="sxs-lookup"><span data-stu-id="f239b-205">Update the *`Server`* project of a hosted Blazor solution as an ASP.NET Core app following the general guidance in this article.</span></span>

<span data-ttu-id="f239b-206">此外，通过 *`Server`* Blazor WebAssembly AZURE ACTIVE DIRECTORY (AAD) 或 B2C 向客户端应用程序进行身份验证的项目应采用新的 Microsoft v2.0 Identity 包：</span><span class="sxs-lookup"><span data-stu-id="f239b-206">Additionally, *`Server`* projects that authenticate users to client Blazor WebAssembly apps with Azure Active Directory (AAD) or B2C should adopt new Microsoft Identity v2.0 packages:</span></span> 
  
<span data-ttu-id="f239b-207">对于 AAD：</span><span class="sxs-lookup"><span data-stu-id="f239b-207">For AAD:</span></span>

```diff
-<PackageReference Include="Microsoft.AspNetCore.Authentication.AzureAD.UI" Version="..." />
+<PackageReference Include="Microsoft.Identity.Web" Version="{VERSION}" />
+<PackageReference Include="Microsoft.Identity.Web.UI" Version="{VERSION}" />
```

<span data-ttu-id="f239b-208">对于 AAD B2C：</span><span class="sxs-lookup"><span data-stu-id="f239b-208">For AAD B2C:</span></span>

```diff
-<PackageReference Include="Microsoft.AspNetCore.Authentication.AzureADB2C.UI" Version="..." />
+<PackageReference Include="Microsoft.Identity.Web" Version="{VERSION}" />
+<PackageReference Include="Microsoft.Identity.Web.UI" Version="{VERSION}" />
```

<span data-ttu-id="f239b-209">对于前面的包引用，请在 NuGet.org 中确定占位符的包版本 `{VERSION}` ：</span><span class="sxs-lookup"><span data-stu-id="f239b-209">For the preceding package references, determine the package versions for the `{VERSION}` placeholders at NuGet.org:</span></span>

* [`Microsoft.Identity.Web`](https://www.nuget.org/packages/Microsoft.Identity.Web)
* [`Microsoft.Identity.Web.UI`](https://www.nuget.org/packages/Microsoft.Identity.Web.UI)

> [!NOTE]
> <span data-ttu-id="f239b-210">*`Server`* 托管解决方案中项目的 SDK Blazor WebAssembly 仍保留 `Microsoft.NET.Sdk.Web` ：</span><span class="sxs-lookup"><span data-stu-id="f239b-210">The SDK of the *`Server`* project in a hosted Blazor WebAssembly solution remains `Microsoft.NET.Sdk.Web`:</span></span>
>
> ```xml
> <Project Sdk="Microsoft.NET.Sdk.Web">
> ```

<span data-ttu-id="f239b-211">有关详细信息，请参阅：</span><span class="sxs-lookup"><span data-stu-id="f239b-211">For more information, see:</span></span>

* <xref:blazor/security/webassembly/hosted-with-azure-active-directory>
* <xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c>

### <a name="clean-and-rebuild-the-solution"></a><span data-ttu-id="f239b-212">清除并重新生成解决方案</span><span class="sxs-lookup"><span data-stu-id="f239b-212">Clean and rebuild the solution</span></span>

<span data-ttu-id="f239b-213">将应用程序或解决方案迁移到 .NET 5 之后，请清除并重新生成应用程序或解决方案。</span><span class="sxs-lookup"><span data-stu-id="f239b-213">After migrating the app or solution to .NET 5, clean and rebuild the app or solution.</span></span> <span data-ttu-id="f239b-214">如果新包引用和缓存包之间存在包不兼容性：</span><span class="sxs-lookup"><span data-stu-id="f239b-214">If package incompatibilities exist between new package references and cached packages:</span></span>

1. <span data-ttu-id="f239b-215">[`dotnet nuget locals`](/dotnet/core/tools/dotnet-nuget-locals)在命令行界面中执行以下命令以清除 NuGet 包缓存：</span><span class="sxs-lookup"><span data-stu-id="f239b-215">Clear NuGet package caches by executing the following [`dotnet nuget locals`](/dotnet/core/tools/dotnet-nuget-locals) command in a command shell:</span></span>

   ```dotnetcli
   dotnet nuget locals --clear all
   ```
   
1. <span data-ttu-id="f239b-216">清除并重新生成应用程序或解决方案。</span><span class="sxs-lookup"><span data-stu-id="f239b-216">Clean and rebuild the app or solution.</span></span>

### <a name="troubleshoot"></a><span data-ttu-id="f239b-217">疑难解答</span><span class="sxs-lookup"><span data-stu-id="f239b-217">Troubleshoot</span></span>

<span data-ttu-id="f239b-218">遵循适用于应用的安全主题末尾的 *故障排除* 指南 Blazor WebAssembly ：</span><span class="sxs-lookup"><span data-stu-id="f239b-218">Follow the *Troubleshoot* guidance at the end of the Blazor WebAssembly security topic that applies to your app:</span></span>

<span data-ttu-id="f239b-219">独立 Blazor WebAssembly 应用：</span><span class="sxs-lookup"><span data-stu-id="f239b-219">Standalone Blazor WebAssembly apps:</span></span>

* [<span data-ttu-id="f239b-220">OIDC 提供程序和 WebAssembly 身份验证库的通用指南</span><span class="sxs-lookup"><span data-stu-id="f239b-220">General guidance for OIDC providers and the WebAssembly Authentication Library</span></span>](xref:blazor/security/webassembly/standalone-with-authentication-library)
* [<span data-ttu-id="f239b-221">Microsoft 帐户</span><span class="sxs-lookup"><span data-stu-id="f239b-221">Microsoft Accounts</span></span>](xref:blazor/security/webassembly/standalone-with-microsoft-accounts)
* [<span data-ttu-id="f239b-222">Azure Active Directory (AAD)</span><span class="sxs-lookup"><span data-stu-id="f239b-222">Azure Active Directory (AAD)</span></span>](xref:blazor/security/webassembly/standalone-with-azure-active-directory)
* [<span data-ttu-id="f239b-223">Azure Active Directory (AAD) B2C</span><span class="sxs-lookup"><span data-stu-id="f239b-223">Azure Active Directory (AAD) B2C</span></span>](xref:blazor/security/webassembly/standalone-with-azure-active-directory-b2c)

<span data-ttu-id="f239b-224">托管 Blazor WebAssembly 应用：</span><span class="sxs-lookup"><span data-stu-id="f239b-224">Hosted Blazor WebAssembly apps:</span></span>

* [<span data-ttu-id="f239b-225">Azure Active Directory (AAD)</span><span class="sxs-lookup"><span data-stu-id="f239b-225">Azure Active Directory (AAD)</span></span>](xref:blazor/security/webassembly/hosted-with-azure-active-directory)
* [<span data-ttu-id="f239b-226">Azure Active Directory (AAD) B2C</span><span class="sxs-lookup"><span data-stu-id="f239b-226">Azure Active Directory (AAD) B2C</span></span>](xref:blazor/security/webassembly/hosted-with-azure-active-directory-b2c)
* [<span data-ttu-id="f239b-227">Identity 服务器</span><span class="sxs-lookup"><span data-stu-id="f239b-227">Identity Server</span></span>](xref:blazor/security/webassembly/hosted-with-identity-server)

### <a name="unauthorized-client-for-azure-active-directory-aad"></a><span data-ttu-id="f239b-228">Azure Active Directory (AAD) 的未经授权客户端</span><span class="sxs-lookup"><span data-stu-id="f239b-228">Unauthorized client for Azure Active Directory (AAD)</span></span>

<span data-ttu-id="f239b-229">升级 Blazor WebAssembly 使用 aad 进行身份验证的应用后，你可能会在用户使用 aad 登录后，在登录回调上收到以下错误：</span><span class="sxs-lookup"><span data-stu-id="f239b-229">After upgrading a Blazor WebAssembly app that uses AAD for authentication, you may receive the following error on the login callback to the app after the user signs in with AAD:</span></span>

> <span data-ttu-id="f239b-230">信息：Microsoft.AspNetCore.Authorization.DefaultAuthorizationService[2] 授权失败。</span><span class="sxs-lookup"><span data-stu-id="f239b-230">info: Microsoft.AspNetCore.Authorization.DefaultAuthorizationService[2] Authorization failed.</span></span> <span data-ttu-id="f239b-231">不符合以下要求：DenyAnonymousAuthorizationRequirement：要求用户经过身份验证。</span><span class="sxs-lookup"><span data-stu-id="f239b-231">These requirements were not met: DenyAnonymousAuthorizationRequirement: Requires an authenticated user.</span></span>

<span data-ttu-id="f239b-232">AAD 返回的登录回叫错误：</span><span class="sxs-lookup"><span data-stu-id="f239b-232">Login callback error from AAD:</span></span>

* <span data-ttu-id="f239b-233">错误：`unauthorized_client`</span><span class="sxs-lookup"><span data-stu-id="f239b-233">Error: `unauthorized_client`</span></span>
* <span data-ttu-id="f239b-234">说明：`AADB2C90058: The provided application is not configured to allow public clients.`</span><span class="sxs-lookup"><span data-stu-id="f239b-234">Description: `AADB2C90058: The provided application is not configured to allow public clients.`</span></span>

<span data-ttu-id="f239b-235">若要解决该错误：</span><span class="sxs-lookup"><span data-stu-id="f239b-235">To resolve the error:</span></span>

1. <span data-ttu-id="f239b-236">在 Azure 门户中访问[应用的清单](/azure/active-directory/develop/reference-app-manifest)。</span><span class="sxs-lookup"><span data-stu-id="f239b-236">In the Azure portal, access the [app's manifest](/azure/active-directory/develop/reference-app-manifest).</span></span>
1. <span data-ttu-id="f239b-237">将 [`allowPublicClient`](/azure/active-directory/develop/reference-app-manifest#allowpublicclient-attribute) 属性设置为 `null` 或 `true`。</span><span class="sxs-lookup"><span data-stu-id="f239b-237">Set the [`allowPublicClient`](/azure/active-directory/develop/reference-app-manifest#allowpublicclient-attribute) attribute to `null` or `true`.</span></span>

## <a name="update-a-no-locblazor-progressive-web-application-pwa"></a><span data-ttu-id="f239b-238">Blazor (PWA 更新渐进式 Web 应用程序) </span><span class="sxs-lookup"><span data-stu-id="f239b-238">Update a Blazor Progressive Web Application (PWA)</span></span>

<span data-ttu-id="f239b-239">将以下项添加到 PWA 应用的项目文件中：</span><span class="sxs-lookup"><span data-stu-id="f239b-239">Add the following item to the PWA app's project file:</span></span>

```xml
<ItemGroup>
  <ServiceWorker Include="wwwroot\service-worker.js" 
    PublishedContent="wwwroot\service-worker.published.js" />
</ItemGroup>
```

## <a name="update-no-locrazor-class-libraries-rcls"></a><span data-ttu-id="f239b-240">Razor (RCLs) 更新类库</span><span class="sxs-lookup"><span data-stu-id="f239b-240">Update Razor class libraries (RCLs)</span></span>

<span data-ttu-id="f239b-241">Razor (RCLs) 迁移类库，以利用 ASP.NET Core 5.0 中引入的新 api 或功能。</span><span class="sxs-lookup"><span data-stu-id="f239b-241">Migrate Razor class libraries (RCLs) to take advantage of new APIs or features that are introduced as part of ASP.NET Core 5.0.</span></span> 

<span data-ttu-id="f239b-242">更新面向组件的 RCL：</span><span class="sxs-lookup"><span data-stu-id="f239b-242">To update a RCL that targets components:</span></span>

1. <span data-ttu-id="f239b-243">更新项目文件中的以下属性：</span><span class="sxs-lookup"><span data-stu-id="f239b-243">Update the following properties in the project file:</span></span>

   ```diff
   <Project Sdk="Microsoft.NET.Sdk.Razor">
    
     <PropertyGroup>
   -     <TargetFramework>netstandard2.0</TargetFramework>
   -     <RazorLangVersion>3.0</RazorLangVersion>
   +     <TargetFramework>net5.0</TargetFramework>
     </PropertyGroup>
   ```

1. <span data-ttu-id="f239b-244">将其他包更新到其最新版本。</span><span class="sxs-lookup"><span data-stu-id="f239b-244">Update other packages to their latest versions.</span></span> <span data-ttu-id="f239b-245">最新版本可在 [NuGet.org](https://www.nuget.org)上找到。</span><span class="sxs-lookup"><span data-stu-id="f239b-245">The latest versions can be found at [NuGet.org](https://www.nuget.org).</span></span>

<span data-ttu-id="f239b-246">若要更新 RCL 目标 MVC，请更新项目文件中的以下属性：</span><span class="sxs-lookup"><span data-stu-id="f239b-246">To update an RCL targeting MVC, update the following properties in the project file:</span></span>

```diff
<Project Sdk="Microsoft.NET.Sdk.Razor">

  <PropertyGroup>
-    <TargetFramework>netcoreapp3.1</TargetFramework>
+    <TargetFramework>net5.0</TargetFramework>
    <AddRazorSupportForMvc>true</AddRazorSupportForMvc>
  </PropertyGroup>
```

## <a name="update-package-references"></a><span data-ttu-id="f239b-247">更新包引用</span><span class="sxs-lookup"><span data-stu-id="f239b-247">Update package references</span></span>

<span data-ttu-id="f239b-248">在项目文件中，将包引用的属性中的每[](https://www.nuget.org/packages?q=Microsoft.EntityFrameworkCore.*)个[AspNetCore. \*](https://www.nuget.org/packages?q=Microsoft.AspNetCore.*)、microsoft.entityframeworkcore [](https://www.nuget.org/packages?q=Microsoft.Extensions.*)和[System.Net.Http.Js](https://www.nuget.org/packages/System.Net.Http.Json)更新 `Version` 为5.0.0 或更高版本。</span><span class="sxs-lookup"><span data-stu-id="f239b-248">In the project file, update each [Microsoft.AspNetCore.\*](https://www.nuget.org/packages?q=Microsoft.AspNetCore.*), [Microsoft.EntityFrameworkCore.\*](https://www.nuget.org/packages?q=Microsoft.EntityFrameworkCore.*), [Microsoft.Extensions.\*](https://www.nuget.org/packages?q=Microsoft.Extensions.*), and [System.Net.Http.Json](https://www.nuget.org/packages/System.Net.Http.Json) package reference's `Version` attribute to 5.0.0 or later.</span></span> <span data-ttu-id="f239b-249">例如：</span><span class="sxs-lookup"><span data-stu-id="f239b-249">For example:</span></span>

```diff
<ItemGroup>
-    <PackageReference Include="Microsoft.AspNetCore.JsonPatch" Version="3.1.6" />
-    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="3.1.6">
-    <PackageReference Include="Microsoft.Extensions.Caching.Abstractions" Version="3.1.6" />
-    <PackageReference Include="System.Net.Http.Json" Version="3.2.1" />
+    <PackageReference Include="Microsoft.AspNetCore.JsonPatch" Version="5.0.0" />
+    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="5.0.0">
+    <PackageReference Include="Microsoft.Extensions.Caching.Abstractions" Version="5.0.0" />
+    <PackageReference Include="System.Net.Http.Json" Version="5.0.0" />
</ItemGroup>
```

## <a name="update-docker-images"></a><span data-ttu-id="f239b-250">更新 Docker 映像</span><span class="sxs-lookup"><span data-stu-id="f239b-250">Update Docker images</span></span>

<span data-ttu-id="f239b-251">对于使用 Docker 的应用，请更新 *Dockerfile* `FROM` 语句和脚本。</span><span class="sxs-lookup"><span data-stu-id="f239b-251">For apps using Docker, update your *Dockerfile* `FROM` statements and scripts.</span></span> <span data-ttu-id="f239b-252">使用包含 ASP.NET Core 5.0 运行时的基本映像。</span><span class="sxs-lookup"><span data-stu-id="f239b-252">Use a base image that includes the ASP.NET Core 5.0 runtime.</span></span> <span data-ttu-id="f239b-253">请考虑以下 `docker pull` 命令 ASP.NET Core 3.1 和5.0 之间的差异：</span><span class="sxs-lookup"><span data-stu-id="f239b-253">Consider the following `docker pull` command difference between ASP.NET Core 3.1 and 5.0:</span></span>

```diff
- docker pull mcr.microsoft.com/dotnet/core/aspnet:3.1
+ docker pull mcr.microsoft.com/dotnet/aspnet:5.0
```

<span data-ttu-id="f239b-254">作为产品名称移动到 ".NET" 的过程中，Docker 映像将从 `mcr.microsoft.com/dotnet/core` 存储库移到 `mcr.microsoft.com/dotnet` 。</span><span class="sxs-lookup"><span data-stu-id="f239b-254">As part of the move to ".NET" as the product name, the Docker images moved from the `mcr.microsoft.com/dotnet/core` repositories to `mcr.microsoft.com/dotnet`.</span></span> <span data-ttu-id="f239b-255">有关详细信息，请参阅 [dotnet/dotnet # 1939](https://github.com/dotnet/dotnet-docker/issues/1939)。</span><span class="sxs-lookup"><span data-stu-id="f239b-255">For more information, see [dotnet/dotnet-docker#1939](https://github.com/dotnet/dotnet-docker/issues/1939).</span></span>

## <a name="model-binding-changes-in-aspnet-core-mvc-and-no-locrazor-pages"></a><span data-ttu-id="f239b-256">ASP.NET Core MVC 和页面中的模型绑定更改 Razor</span><span class="sxs-lookup"><span data-stu-id="f239b-256">Model binding changes in ASP.NET Core MVC and Razor Pages</span></span>

### <a name="datetime-values-are-model-bound-as-utc-times"></a><span data-ttu-id="f239b-257">DateTime 值是作为 UTC 时间的模型绑定</span><span class="sxs-lookup"><span data-stu-id="f239b-257">DateTime values are model bound as UTC times</span></span>

<span data-ttu-id="f239b-258">在 ASP.NET Core 3.1 及更早版本中， `DateTime` 值作为本地时间进行建模，其中时区由服务器决定。</span><span class="sxs-lookup"><span data-stu-id="f239b-258">In ASP.NET Core 3.1 and earlier, `DateTime` values were model-bound as local time, where the timezone was determined by the server.</span></span> <span data-ttu-id="f239b-259">`DateTime` 绑定自输入格式 (JSON) 和值的值 `DateTimeOffset` 被绑定为 UTC 时区。</span><span class="sxs-lookup"><span data-stu-id="f239b-259">`DateTime` values bound from input formatting (JSON) and `DateTimeOffset` values were bound as UTC timezones.</span></span>

<span data-ttu-id="f239b-260">在 ASP.NET Core 5.0 及更高版本中，模型绑定 `DateTime` 将值与 UTC 时区一致地绑定在一起。</span><span class="sxs-lookup"><span data-stu-id="f239b-260">In ASP.NET Core 5.0 and later, model binding consistently binds `DateTime` values with the UTC timezone.</span></span>

<span data-ttu-id="f239b-261">若要保留以前的行为，请 `DateTimeModelBinderProvider` 在中删除 `Startup.ConfigureServices` ：</span><span class="sxs-lookup"><span data-stu-id="f239b-261">To retain the previous behavior, remove the `DateTimeModelBinderProvider` in `Startup.ConfigureServices`:</span></span>

```csharp
services.AddControllersWithViews(options => 
    options.ModelBinderProviders.RemoveType<DateTimeModelBinderProvider>());
```

### <a name="complexobjectmodelbinderprovider--complexobjectmodelbinder-replace-complextypemodelbinderprovider--complextypemodelbinder"></a><span data-ttu-id="f239b-262">ComplexObjectModelBinderProvider \ ComplexObjectModelBinder replace ComplexTypeModelBinderProvider \ ComplexTypeModelBinder</span><span class="sxs-lookup"><span data-stu-id="f239b-262">ComplexObjectModelBinderProvider \ ComplexObjectModelBinder replace ComplexTypeModelBinderProvider \ ComplexTypeModelBinder</span></span>

<span data-ttu-id="f239b-263">若要添加对模型绑定 [c # 9 记录类型](/dotnet/csharp/whats-new/csharp-9#record-types)的支持，请 <xref:Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexTypeModelBinderProvider> 执行以下操作：</span><span class="sxs-lookup"><span data-stu-id="f239b-263">To add support for model binding [C# 9 record types](/dotnet/csharp/whats-new/csharp-9#record-types), the <xref:Microsoft.AspNetCore.Mvc.ModelBinding.Binders.ComplexTypeModelBinderProvider> is:</span></span>

* <span data-ttu-id="f239b-264">注释为过时。</span><span class="sxs-lookup"><span data-stu-id="f239b-264">Annotated as obsolete.</span></span>
* <span data-ttu-id="f239b-265">不再在默认情况下注册。</span><span class="sxs-lookup"><span data-stu-id="f239b-265">No longer registered by default.</span></span>

<span data-ttu-id="f239b-266">依赖于集合中存在的应用 `ComplexTypeModelBinderProvider` `ModelBinderProviders` 需要引用新的联编程序提供程序：</span><span class="sxs-lookup"><span data-stu-id="f239b-266">Apps that rely on the presence of the `ComplexTypeModelBinderProvider` in the `ModelBinderProviders` collection need to reference the new binder provider:</span></span>

```diff
- var complexModelBinderProvider = options.ModelBinderProviders.OfType<ComplexTypeModelBinderProvider>();
+ var complexModelBinderProvider = options.ModelBinderProviders.OfType<ComplexObjectModelBinderProvider>();
```

## <a name="usedatabaseerrorpage-obsolete"></a><span data-ttu-id="f239b-267">UseDatabaseErrorPage 已过时</span><span class="sxs-lookup"><span data-stu-id="f239b-267">UseDatabaseErrorPage obsolete</span></span>

<span data-ttu-id="f239b-268">包含单个用户帐户的选项的 ASP.NET Core 3.1 模板将生成对的调用 <xref:Microsoft.AspNetCore.Builder.DatabaseErrorPageExtensions.UseDatabaseErrorPage%2A> 。</span><span class="sxs-lookup"><span data-stu-id="f239b-268">The ASP.NET Core 3.1 templates that include an option for individual user accounts generate a call to <xref:Microsoft.AspNetCore.Builder.DatabaseErrorPageExtensions.UseDatabaseErrorPage%2A>.</span></span> <span data-ttu-id="f239b-269">`UseDatabaseErrorPage` 现已过时，应替换为和的组合 `AddDatabaseDeveloperPageExceptionFilter` `UseMigrationsEndPoint` ，如以下代码所示：</span><span class="sxs-lookup"><span data-stu-id="f239b-269">`UseDatabaseErrorPage` is now obsolete and should be replaced with a combination of `AddDatabaseDeveloperPageExceptionFilter` and `UseMigrationsEndPoint`, as shown in the following code:</span></span>

```diff
public void ConfigureServices(IServiceCollection services)
{
    services.AddDbContext<ApplicationDbContext>(options =>
        options.UseSqlServer(
            Configuration.GetConnectionString("DefaultConnection")));
+   services.AddDatabaseDeveloperPageExceptionFilter();
    services.AddDefaultIdentity<IdentityUser>(options => options.SignIn.RequireConfirmedAccount = true)
        .AddEntityFrameworkStores<ApplicationDbContext>();
    services.AddRazorPages();
}

public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
+       app.UseMigrationsEndPoint();
-       app.UseDatabaseErrorPage();
    }
    else
    {
        app.UseExceptionHandler("/Error");
        app.UseHsts();
    }
```

<span data-ttu-id="f239b-270">有关详细信息，请参阅[此 GitHub 问题](https://github.com/dotnet/aspnetcore/issues/24987)。</span><span class="sxs-lookup"><span data-stu-id="f239b-270">For more information, see [this GitHub issue](https://github.com/dotnet/aspnetcore/issues/24987).</span></span>

## <a name="review-breaking-changes"></a><span data-ttu-id="f239b-271">查看重大更改</span><span class="sxs-lookup"><span data-stu-id="f239b-271">Review breaking changes</span></span>

<span data-ttu-id="f239b-272">有关从 .NET Core 3.1 到 .NET 5.0 的重大更改，请参阅 [从版本3.1 迁移到5.0 的重大更改](/dotnet/core/compatibility/3.1-5.0)。</span><span class="sxs-lookup"><span data-stu-id="f239b-272">For breaking changes from .NET Core 3.1 to .NET 5.0, see [Breaking changes for migration from version 3.1 to 5.0](/dotnet/core/compatibility/3.1-5.0).</span></span> <span data-ttu-id="f239b-273">ASP.NET Core 和 Entity Framework Core 也包含在列表中。</span><span class="sxs-lookup"><span data-stu-id="f239b-273">ASP.NET Core and Entity Framework Core are also included in the list.</span></span>
